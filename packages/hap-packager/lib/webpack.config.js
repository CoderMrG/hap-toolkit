"use strict";const fs=require("fs"),path=require("path"),VueLoaderPlugin=require("vue-loader/lib/plugin"),MiniCssExtractPlugin=require("mini-css-extract-plugin"),globalConfig=require("@hap-toolkit/shared-utils/config"),{initOptions:initOptions,options:compileOptions}=require("@hap-toolkit/shared-utils/compilation-config"),Css2jsonPlugin=require("@hap-toolkit/dsl-vue/lib/css2json-plugin"),InstVuePlugin=require("@hap-toolkit/dsl-vue/lib/instvue-plugin"),info=require("./common/info"),CopyDslPlugin=require("./plugin/copy-dsl-plugin"),HandlerPlugin=require("./plugin/handler-plugin"),ResourcePlugin=require("./plugin/resource-plugin"),ZipPlugin=require("./plugin/zip-plugin"),NotifyPlugin=require("./plugin/notify-plugin"),{colorconsole:colorconsole,loadBabelModule:loadBabelModule}=require("./common/utils"),FILE_EXT_LIST=info.name.extList;function genPriorities(e){const o=["manifest.json","app.js",/^common\//i];if(e&&e.router&&e.router.entry){const i=e.router.entry;o.splice(2,0,new RegExp(`^${i}/$`),new RegExp(`^${i}/.+`))}else colorconsole.error("manifest.json 中未配置入口页面 router.entry");return o}function getManifest(e){let o;try{const i=fs.readFileSync(e).toString();o=JSON.parse(i)}catch(e){colorconsole.error(`读取 manifest.json 失败： ${e.message}`)}return o||{}}function resolveLoader(e){return require.resolve(`./loader/${e}`)}function postHook(e,o,i){const n=globalConfig.projectPath,{appPackageName:s,versionCode:r,pathDist:t,pathBuild:l,pathSignFolder:a,pathSrc:u,subpackages:p,workers:c}=o;initOptions(i);const g=getManifest(path.join(u,"manifest.json")),d=genPriorities(g);e.module.rules.push({test:new RegExp(`(${FILE_EXT_LIST.slice(0,2).map(e=>"\\"+e).join("|")})(\\?[^?]+)?$`),use:resolveLoader("ux-loader.js")},{test:new RegExp(`(${FILE_EXT_LIST.slice(2).map(e=>"\\"+e).join("|")})(\\?[^?]+)?$`),use:[{loader:resolveLoader("module-loader.js")},{loader:require.resolve("vue-loader"),options:{hotReload:!1}},{loader:resolveLoader("manifest-loader.js"),options:{path:u}},{loader:require.resolve("@hap-toolkit/dsl-vue/lib/validator-loader")}]},{test:/\.css$/,use:[MiniCssExtractPlugin.loader,"css-loader"]},{test:/\.js$/,use:[resolveLoader("module-loader.js"),{loader:loadBabelModule("babel-loader"),options:{cwd:n}}]},{test:/\.(png|jpe?g|gif|svg|bmp|webp|mp4|wmv|avi|mpg|rmvb|mov|flv|otf|ttf|ttc|woff|eot)$/i,use:{loader:require.resolve("file-loader"),options:{publicPath:e=>{const o=/^src/;return o.test(e)?e.replace(o,""):"/"+e},context:n,name:"[path][name].[ext]",emitFile:!1}}});const m="dev"===process.env.NODE_PHASE&&i.sign,f="dev"!==process.env.NODE_PHASE&&!i.debug,h=m||f,v=h?"release":"debug",P=JSON.stringify({toolkit:require("../package.json").version,timeStamp:(new Date).toJSON(),node:process.version,platform:process.platform,arch:process.arch,extends:i.packageExtends||null});if(i.includeDslFromLib&&e.plugins.unshift(new CopyDslPlugin({cwd:n,config:g.config})),e.plugins.push(new VueLoaderPlugin,new MiniCssExtractPlugin({filename:"[name].css.json"}),new Css2jsonPlugin,new HandlerPlugin({pathSrc:u,workers:c}),new ResourcePlugin({src:u,dest:l,sign:h,projectRoot:globalConfig.projectPath,optimizeUnusedResource:i.optimizeUnusedResource}),new InstVuePlugin,new ZipPlugin({name:s,versionCode:r,output:t,pathBuild:l,pathSignFolder:a,sign:v,priorities:d,subpackages:p,comment:P,cwd:n,disableStreamPack:i.disableStreamPack,disableSubpackages:i.disableSubpackages}),new NotifyPlugin),compileOptions.stats){const o=require("webpack-bundle-analyzer").BundleAnalyzerPlugin;e.plugins.push(new o({analyzerMode:"static",openAnalyzer:!1}))}}module.exports={postHook:postHook};
//# sourceMappingURL=webpack.config.js.map
