"use strict";const path=require("path"),webpack=require("webpack"),chokidar=require("chokidar"),{setCustomConfig:setCustomConfig,colorconsole:colorconsole,debounce:debounce}=require("@hap-toolkit/shared-utils"),globalConfig=require("@hap-toolkit/shared-utils/config"),genWebpackConf=require("../../gen-webpack-conf");let watching=null;function showVersion(){const o=require("../../package.json").version,e=require("@babel/core/package.json").version,r=require("webpack/package.json").version;colorconsole.log(`hap-toolkit: ${o}; babel: ${e}; webpack: ${r}`)}showVersion(),module.exports.compile=function o(e,r,s,n={}){return new Promise((c,t)=>{function a(o,e){const r=n.onerror||function(){};let s;if(o&&(colorconsole.error(o),s=o),e&&e.hasErrors()){let o;e.compilation.errors.forEach(e=>{o=e.message;const r=/Can't resolve '(sass-loader|less-loader|stylus-loader)'/.exec(o);if("ModuleNotFoundError"===e.name&&r){let e=r[1];"less-loader"===e?e=`less ${e}`:"sass-loader"===e?e=`node-sass ${e}`:"stylus-loader"===e&&(e=`stylus ${e}`),o+=` 缺少依赖: ${e}, 请执行 \`npm install -D ${e}\` 安装相应依赖 `}colorconsole.error("构建错误",o)}),s=new Error(o)}s&&r(s)}colorconsole.init(n.log),setCustomConfig(n.cwd),process.env.NODE_PLATFORM=e,process.env.NODE_PHASE=r;const i="prod"===r?"production":"development";try{const l=genWebpackConf(n,i);if(s){const t=webpack(l);watching=t.watch({aggregateTimeout:300},(o,e)=>{a(o,e),c({compileError:o,stats:e,watching:watching})});const i=path.join(globalConfig.projectPath,"src/manifest.json"),u=chokidar.watch(i);u.on("change",debounce(function(){colorconsole.info("### App Server ### manifest.json 文件修改，编译重启"),u.unwatch(i),u.close(),watching.close(()=>{o(e,r,s,n)})},300))}else webpack(l,(o,e)=>{a(o,e),c({compileError:o,stats:e})})}catch(o){t(o)}})},module.exports.stopWatch=function(){return new Promise(o=>{watching?watching.close(()=>{o({stopWatchError:null})}):o({stopWatchError:"no watching"})})};
//# sourceMappingURL=compile.js.map
